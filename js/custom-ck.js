/**
 * =====================================================================
 * WebKit - 808
 * Cameron J Roe
 * Version: 1.0
 * =====================================================================
 *//* Globals */function init(){context=new webkitAudioContext;loadAssets();initControls();initButtons()}function getData(e){var t,n=new XMLHttpRequest;n.open("GET",e,!1);n.onreadystatechange=function(){n.status===200&&n.readyState===4&&(t=JSON.parse(n.responseText))};n.send();return t}function loadDemoKit(e,t,n,r){loadBeat(e);var i=new Kit;e.name==="demo808"?i.load():i.load(e.name);$(".pitch").val(t).trigger("change");$(".tempo").val(n).trigger("change");$(".swing").val(r).trigger("change")}function handleLoadDemo(e){var t=e.target.id;switch(t){case"funkyHouse":loadDemoKit(funkyHouse,1,126,5);break;case"hiphop":loadDemoKit(hiphop,1,83,5);break;case"dubstep":loadDemoKit(dubstep,0,70,0);break;case"demo808":loadDemoKit(demo808,0,114,4)}}function cloneBeat(e){var t=new Object;t.kitIndex=e.kitIndex;t.effectIndex=e.effectIndex;t.tempo=e.tempo;t.swingFactor=e.swingFactor;t.effectMix=e.effectMix;t.kickPitchVal=e.kickPitchVal;t.snarePitchVal=e.snarePitchVal;t.hihatPitchVal=e.hihatPitchVal;t.tom1PitchVal=e.tom1PitchVal;t.tom2PitchVal=e.tom2PitchVal;t.tom3PitchVal=e.tom3PitchVal;t.rhythm1=e.rhythm1.slice(0);t.rhythm2=e.rhythm2.slice(0);t.rhythm3=e.rhythm3.slice(0);t.rhythm4=e.rhythm4.slice(0);t.rhythm5=e.rhythm5.slice(0);t.rhythm6=e.rhythm6.slice(0);return t}function Kit(){this.kickPath=null;this.snarePath=null;this.hihatPath=null;this.tom1Path=null;this.tom2Path=null;this.tom3Path=null;this.kickBuffer=null;this.snareBuffer=null;this.hihatBuffer=null;this.tom1Buffer=null;this.tom2Buffer=null;this.tom3Buffer=null;this.kickMuted=!1;this.snareMuted=!1;this.hihatMuted=!1;this.tom1Muted=!1;this.tom2Muted=!1;this.tom3Muted=!1;this.startedLoading=!1;this.isLoaded=!1;this.isPlaying=!1}function loadAssets(){var e=new Kit;e.load();e.isLoaded=!0;currentKit=e}function playSound(e,t){var n=context.createBufferSource();n.buffer=e;n.playbackRate.value=pitch;n.gain.value=1;var r=context.createGainNode();r.gain.value=1;n.connect(r);r.connect(context.destination);n.noteOn(t)}function schedule(){var e=context.currentTime;e-=startTime;while(noteTime<e+.2){var t=noteTime+startTime;theBeat.rhythm1[rhythmIndex]&&currentKit.kickMuted===!1&&playSound(currentKit.kickBuffer,t);theBeat.rhythm2[rhythmIndex]&&currentKit.snareMuted===!1&&playSound(currentKit.snareBuffer,t);theBeat.rhythm3[rhythmIndex]&&currentKit.hihatMuted===!1&&playSound(currentKit.hihatBuffer,t);theBeat.rhythm4[rhythmIndex]&&currentKit.tom1Muted===!1&&playSound(currentKit.tom1Buffer,t);theBeat.rhythm5[rhythmIndex]&&currentKit.tom2Muted===!1&&playSound(currentKit.tom2Buffer,t);theBeat.rhythm6[rhythmIndex]&&currentKit.tom3Muted===!1&&playSound(currentKit.tom3Buffer,t);if(noteTime!=lastDrawTime){lastDrawTime=noteTime;drawPlayhead((rhythmIndex+15)%16)}advanceNote()}timeoutId=setTimeout(schedule,0)}function handlePlay(){currentKit.isPlaying=!0;noteTime=0;startTime=context.currentTime+.005;schedule();var e=document.getElementById("play");e.removeEventListener("click",handlePlay,!1);e.textContent="Stop";e.id="stop";e.classList.remove("success");e.classList.add("alert");e.classList.add("playing");e.addEventListener("click",handleStop,!1);e.addEventListener("dblclick",resetBeat,!0)}function handleStop(){currentKit.isPlaying=!1;clearTimeout(timeoutId);rhythmIndex=0;if(document.getElementById("stop")){var e=document.getElementById("stop");e.removeEventListener("click",handleStop,!1);e.id="play";e.classList.remove("alert");e.textContent="Play";e.classList.add("success");e.classList.remove("playing");e.addEventListener("click",handlePlay,!1)}drawPlayhead(rhythmIndex)}function toggleMute(e){function s(e,t){for(i=0;i<loopLength;i++)r[i]===1&&t?drawNote(2,i,e):drawNote(r[i],i,e)}e.preventDefault();var t=e.target.parentNode;t.classList.toggle("active");var n,r;if(t.classList.contains("active")){console.log("Muted");switch(t.id){case"kick_mute":currentKit.kickMuted=!0;r=theBeat.rhythm1;n=0;break;case"snare_mute":currentKit.snareMuted=!0;r=theBeat.rhythm2;n=1;break;case"hihat_mute":currentKit.hihatMuted=!0;r=theBeat.rhythm3;n=2;break;case"tom1_mute":currentKit.tom1Muted=!0;r=theBeat.rhythm4;n=3;break;case"tom2_mute":currentKit.tom2Muted=!0;r=theBeat.rhythm5;n=4;break;case"tom3_mute":currentKit.tom3Muted=!0;r=theBeat.rhythm6;n=5}s(n,!0)}else{console.log("Unmuted");switch(t.id){case"kick_mute":currentKit.kickMuted=!1;r=theBeat.rhythm1;n=0;break;case"snare_mute":currentKit.snareMuted=!1;r=theBeat.rhythm2;n=1;break;case"hihat_mute":currentKit.hihatMuted=!1;r=theBeat.rhythm3;n=2;break;case"tom1_mute":currentKit.tom1Muted=!1;r=theBeat.rhythm4;n=3;break;case"tom2_mute":currentKit.tom2Muted=!1;r=theBeat.rhythm5;n=4;break;case"tom3_mute":currentKit.tom3Muted=!1;r=theBeat.rhythm6;n=5}s(n,!1)}}function handleClear(e){e.preventDefault();var t=e.target.parentNode,n=t.id,r;switch(n){case"kick_clear":r=0;break;case"snare_clear":r=1;break;case"hihat_clear":r=2;break;case"tom1_clear":r=3;break;case"tom2_clear":r=4;break;case"tom3_clear":r=5}clearBeat(r)}function clearBeat(e){switch(e){case 0:theBeat.rhythm1=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];break;case 1:theBeat.rhythm2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];break;case 2:theBeat.rhythm3=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];break;case 3:theBeat.rhythm4=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];break;case 4:theBeat.rhythm5=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];break;case 5:theBeat.rhythm6=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];break;default:return!1}for(var t=0;t<loopLength;t++)drawNote(0,t,e)}function onKeyDown(e){e.keyCode===32?currentKit.isPlaying?handleStop():handlePlay():e.keyCode===67&&resetBeat()}function initControls(){window.addEventListener("keydown",onKeyDown);document.getElementById("play").addEventListener("click",handlePlay,!1);document.getElementById("clear").addEventListener("click",resetBeat,!1);document.getElementById("funkyHouse").addEventListener("click",handleLoadDemo,!1);document.getElementById("hiphop").addEventListener("click",handleLoadDemo,!1);document.getElementById("dubstep").addEventListener("click",handleLoadDemo,!1);document.getElementById("demo808").addEventListener("click",handleLoadDemo,!1)}function initButtons(){var e,t,n=instruments.length;for(var r=0;r<loopLength;++r)for(j=0;j<n;j++){e=document.getElementById(instruments[j]+"_"+r);e.addEventListener("mousedown",handleButtonMouseDown,!0)}for(var r=0;r<n;r++){t=document.getElementById(instruments[r]+"_mute");t.querySelector("a").addEventListener("mousedown",toggleMute,!0)}for(var r=0;r<n;r++){t=document.getElementById(instruments[r]+"_clear");t.querySelector("a").addEventListener("mousedown",handleClear,!0)}}function handleButtonMouseDown(e){var t=theBeat.rhythm1,n,r,i=e.target.id;r=i.substr(i.indexOf("_")+1,2);n=instruments.indexOf(i.substr(0,i.indexOf("_")));switch(n){case 0:t=theBeat.rhythm1;break;case 1:t=theBeat.rhythm2;break;case 2:t=theBeat.rhythm3;break;case 3:t=theBeat.rhythm4;break;case 4:t=theBeat.rhythm5;break;case 5:t=theBeat.rhythm6}t[r]=(t[r]+1)%2;console.log(t[r]);drawNote(t[r],r,n);var s=t[r];if(s)switch(n){case 0:currentKit.kickMuted===!1&&playSound(currentKit.kickBuffer);break;case 1:currentKit.snareMuted===!1&&playSound(currentKit.snareBuffer);break;case 2:currentKit.hihatMuted===!1&&playSound(currentKit.hihatBuffer);break;case 3:currentKit.tom1Muted===!1&&playSound(currentKit.tom1Buffer);break;case 4:currentKit.tom2Muted===!1&&playSound(currentKit.tom2Buffer);break;case 5:currentKit.tom3Muted===!1&&playSound(currentKit.tom3Buffer)}}function drawNote(e,t,n){var r=document.getElementById(instruments[n]+"_"+t),i=document.getElementById(instruments[n]+"_mute"),s=i.classList.contains("active"),o=r.classList.contains("muted");switch(e){case 0:o?r.classList.remove("muted"):r.classList.remove("alert");break;case 1:s?r.classList.add("muted"):r.classList.add("alert");break;case 2:r.classList.remove("alert");r.classList.add("muted")}}function advanceNote(){var e=60/theBeat.tempo;rhythmIndex++;rhythmIndex==loopLength&&(rhythmIndex=0);rhythmIndex%2?noteTime+=(.25+kMaxSwing*theBeat.swingFactor)*e:noteTime+=(.25-kMaxSwing*theBeat.swingFactor)*e}function resetBeat(){handleStop();loadBeat(beatReset)}function drawPlayhead(e){var t=e*100/15,n=document.getElementById("transport-meter");n.firstChild.style.width=t+"%"}function loadBeat(e){handleStop();theBeat=cloneBeat(e);updateControls();return!0}function updateControls(){for(i=0;i<loopLength;++i)for(j=0;j<instruments.length;j++){switch(j){case 0:notes=theBeat.rhythm1;break;case 1:notes=theBeat.rhythm2;break;case 2:notes=theBeat.rhythm3;break;case 3:notes=theBeat.rhythm4;break;case 4:notes=theBeat.rhythm5;break;case 5:notes=theBeat.rhythm6}drawNote(notes[i],i,j)}}var context,loopLength=16,rhythmIndex=null,minTempo=50,maxTempo=180,noteTime,lastDrawTime=-1,timeoutId,pitch=1,sliderVal,kMaxSwing=.08,currentKit,rec,instruments=["kick","snare","hihat","tom1","tom2","tom3"];window.onload=init;var data=getData("js/data/kits.json"),beatReset=data.beatReset,funkyHouse=data.funkyHouse,hiphop=data.hiphop,demo808=data.demo808,theBeat=cloneBeat(beatReset);Kit.prototype.load=function(e){if(this.startedLoading)return!1;this.startedLoading=!0;switch(e){case"dubstep":this.kickPath="samples/dubstepKick.wav";this.snarePath="samples/dubstepClap.wav";this.hihatPath="samples/dubstepHH.wav";this.tom1Path="samples/dubstepTom.wav";this.tom2Path="samples/dubstepTom1.wav";this.tom3Path="samples/dubstepReverse.wav";break;case"hiphop":this.kickPath="samples/hiphopKick.wav";this.snarePath="samples/hiphopSnare.wav";this.hihatPath="samples/hiphopHH.wav";this.tom1Path="samples/hiphopTom.wav";this.tom2Path="samples/hiphopTom1.wav";this.tom3Path="samples/hiphopTom2.wav";break;case"funkyHouse":this.kickPath="samples/909bd4.wav";this.snarePath="samples/909clap2.wav";this.hihatPath="samples/909ophat1.WAV";this.tom1Path="samples/TOM04L.WAV";this.tom2Path="samples/TOM04M.WAV";this.tom3Path="samples/TOM05H.WAV";break;default:this.kickPath="samples/808kick.WAV";this.snarePath="samples/808clap.WAV";this.hihatPath="samples/808hihat.WAV";this.tom1Path="samples/808tom1.WAV";this.tom2Path="samples/808tom2.WAV";this.tom3Path="samples/808tom3.WAV"}this.loadSample(0,this.kickPath,!1);this.loadSample(1,this.snarePath,!1);this.loadSample(2,this.hihatPath,!1);this.loadSample(3,this.tom1Path,!1);this.loadSample(4,this.tom2Path,!1);this.loadSample(5,this.tom3Path,!1)};Kit.prototype.loadSample=function(e,t,n){var r=new XMLHttpRequest;r.open("GET",t,!0);r.responseType="arraybuffer";var i=this;r.onload=function(){context.decodeAudioData(r.response,function(t){switch(e){case 0:i.kickBuffer=t;break;case 1:i.snareBuffer=t;break;case 2:i.hihatBuffer=t;break;case 3:i.tom1Buffer=t;break;case 4:i.tom2Buffer=t;break;case 5:i.tom3Buffer=t}})};r.send()};